version: "3"

services:
  # deploy spm-client as global service
  spm-client-solr:
   image: sematext/spm-client:auto-discovery
   container_name: spm-client-autodisco
   hostname: spm-client-autodisco
   volumes: 
     - /var/run/docker.sock:/var/run/docker.sock
   deploy:
      mode: global
      restart_policy:
        condition: any
# run some solr nodes, setting SPM_TOKEN as label and set JMX port to 3000
  solr1:
    image: solr
    ports:
      - "8983:8983"
    labels:
      - SPM_TOKEN=${SPM_TOKEN}
    environment:
      - SOLR_OPTS=-Dcom.sun.management.jmxremote.port=3000 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false
    command: bin/solr -f

  solr2:
    image: solr
    ports:
      - "8984:8983"
    environment:
      - SPM_TOKEN=${SPM_TOKEN}
      - SOLR_OPTS=-Dcom.sun.management.jmxremote.port=3000 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false
    command: bin/solr -f
